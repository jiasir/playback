<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Playback by jiasir</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Playback</h1>
      <h2 class="project-tagline">OpenStack provision tools</h2>
      <a href="https://github.com/jiasir/playback" class="btn">View on GitHub</a>
      <a href="https://github.com/jiasir/playback/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/jiasir/playback/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      
<h1><a id="Quickstart_0"></a>Quickstart</h1>
<h2><a id="Requirements_2"></a>Requirements</h2>
<ul>
<li>The OpenStack bare metal hosts are in MAAS environment(recommend)</li>
<li>All hosts are two NICs at least(external and internal)</li>
<li>We assume that you have ceph installed, the cinder bachend default using ceph, the running instace default to using ceph as itâ€™s local storage. About ceph please visit: <a href="http://docs.ceph.com/docs/master/rbd/rbd-openstack/">http://docs.ceph.com/docs/master/rbd/rbd-openstack/</a> or see the (Option)Ceph Guide below.</li>
<li>The playback node is the same as ceph-deploy node where can be login to each openstack node passwordless and sudo-passwordless</li>
<li>The playback node default using ~/.ssh/id_rsa ssh private key to logon remote server</li>
<li>You need to restart the <code>nova-compute</code>, <code>cinder-volume</code> and <code>glance-api</code> services to finalize the installation if you have selected the ceph as that backend</li>
<li>Playback support consistency groups for future use but the default LVM and Ceph driver does not support consistency groups yet because the consistency technology is not available at that storage level</li>
</ul>
<h2><a id="Install_Playback_12"></a>Install Playback</h2>
<p>Install playback on PLAYBACK-NODE</p>
<pre><code>pip install playback
</code></pre>
<h2><a id="Prepare_environment_18"></a>Prepare environment</h2>
<p>Prepare the OpenStack environment.
(NOTE) DO NOT setup eth1 in /etc/network/interfaces</p>
<pre><code>env-deploy --user ubuntu --hosts \
HAPROXY1,\
HAPROXY2,\
CONTROLLER1,\
CONTROLLER2,\
COMPUTE1,\
COMPUTE2,\
COMPUTE3,\
COMPUTE4,\
COMPUTE5,\
COMPUTE6,\
COMPUTE7,\
COMPUTE8,\
COMPUTE9,\
COMPUTE10 \
prepare-host --public-interface eth1
</code></pre>
<h2><a id="MySQL_HA_40"></a>MySQL HA</h2>
<p>Deploy to CONTROLLER1</p>
<pre><code>mysql-deploy --user ubuntu --hosts CONTROLLER1 install
mysql-deploy --user ubuntu --hosts CONTROLLER1 config  --wsrep-cluster-address &quot;gcomm://CONTROLLER1,CONTROLLER2&quot; --wsrep-node-name=&quot;galera1&quot; --wsrep-node-address=&quot;CONTROLLER1&quot;
</code></pre>
<p>Deploy to CONTROLLER2</p>
<pre><code>mysql-deploy --user ubuntu --hosts CONTROLLER2 install
mysql-deploy --user ubuntu --hosts CONTROLLER2 config  --wsrep-cluster-address &quot;gcomm://CONTROLLER1,CONTROLLER2&quot; --wsrep-node-name=&quot;galera2&quot; --wsrep-node-address=&quot;CONTROLLER2&quot;
</code></pre>
<p>Start the cluster</p>
<pre><code>mysql-deploy --user ubuntu --hosts CONTROLLER1 manage --wsrep-new-cluster
mysql-deploy --user ubuntu --hosts CONTROLLER2 manage --start
mysql-deploy --user ubuntu --hosts CONTROLLER1 manage --change-root-password changeme
</code></pre>
<p>Show the cluster status</p>
<pre><code>mysql-deploy --user ubuntu --hosts CONTROLLER1 manage --show-cluster-status --root-db-pass changeme
</code></pre>
<h2><a id="HAProxy_HA_63"></a>HAProxy HA</h2>
<p>Deploy to HAPROXY1</p>
<pre><code>haproxy-deploy --user ubuntu --hosts HAPROXY1 install
</code></pre>
<p>Deploy to HAPROXY2</p>
<pre><code>haproxy-deploy --user ubuntu --hosts HAPROXY2 install
</code></pre>
<p>Generate the HAProxy configuration and upload to target hosts(Do not forget to edit the generated configuration)</p>
<pre><code>haproxy-deploy gen-conf
haproxy-deploy --user ubuntu --hosts HAPROXY1,HAPROXY2 config --upload-conf haproxy.cfg
</code></pre>
<p>Configure Keepalived</p>
<pre><code>haproxy-deploy --user ubuntu --hosts HAPROXY1 config --configure-keepalived --router_id lb1 --priority 150 --state MASTER --interface eth0 --vip CONTROLLER_VIP
haproxy-deploy --user ubuntu --hosts HAPROXY2 config --configure-keepalived --router_id lb2 --priority 100 --state SLAVE --interface eth0 --vip CONTROLLER_VIP
</code></pre>
<h2><a id="RabbitMQ_HA_83"></a>RabbitMQ HA</h2>
<p>Deploy to CONTROLLER1 and CONTROLLER2</p>
<pre><code>rabbitmq-deploy --user ubuntu --hosts CONTROLLER1,CONTROLLER2 install --erlang-cookie changemechangeme --rabbit-user openstack --rabbit-pass changeme
</code></pre>
<p>Create cluster(Ensure CONTROLLER2 can access CONTROLLER1 via hostname)</p>
<pre><code>rabbitmq-deploy --user ubuntu --hosts CONTROLLER2 join-cluster --name rabbit@CONTROLLER1
</code></pre>
<h2><a id="Keystone_HA_93"></a>Keystone HA</h2>
<p>Create keystone database</p>
<pre><code>keystone-deploy --user ubuntu --hosts CONTROLLER1 create-keystone-db --root-db-pass changeme --keystone-db-pass changeme
</code></pre>
<p>Install keystone on CONTROLLER1 and CONTROLLER2</p>
<pre><code>keystone-deploy --user ubuntu --hosts CONTROLLER1 install --admin-token changeme --connection mysql+pymysql://keystone:changeme@CONTROLLER_VIP/keystone --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --populate
keystone-deploy --user ubuntu --hosts CONTROLLER2 install --admin-token changeme --connection mysql+pymysql://keystone:changeme@CONTROLLER_VIP/keystone --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
</code></pre>
<p>Create the service entity and API endpoints</p>
<pre><code>keystone-deploy --user ubuntu --hosts CONTROLLER1 create-entity-and-endpoint --os-token changeme --os-url http://CONTROLLER_VIP:35357/v3 --public-endpoint http://CONTROLLER_VIP:5000/v3 --internal-endpoint http://CONTROLLER_VIP:5000/v3 --admin-endpoint http://CONTROLLER_vip:35357/v3
</code></pre>
<p>Create projects, users, and roles</p>
<pre><code>keystone-deploy --user ubuntu --hosts CONTROLLER1 create-projects-users-roles --os-token changeme --os-url http://CONTROLLER_VIP:35357/v3 --admin-pass changeme --demo-pass changeme
</code></pre>
<p>(OPTION) you will need to create OpenStack client environment scripts
<a href="http://admin-openrc.sh">admin-openrc.sh</a></p>
<pre><code>export OS_PROJECT_DOMAIN_NAME=default
export OS_USER_DOMAIN_NAME=default
export OS_PROJECT_NAME=admin
export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=changeme
export OS_AUTH_URL=http://CONTROLLER_VIP:35357/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
export OS_AUTH_VERSION=3
</code></pre>
<p><a href="http://demo-openrc.sh">demo-openrc.sh</a></p>
<pre><code>export OS_PROJECT_DOMAIN_NAME=default
export OS_USER_DOMAIN_NAME=default
export OS_PROJECT_NAME=demo
export OS_TENANT_NAME=demo
export OS_USERNAME=demo
export OS_PASSWORD=changeme
export OS_AUTH_URL=http://CONTROLLER_VIP:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
export OS_AUTH_VERSION=3
</code></pre>
<h2><a id="Glance_HA_139"></a>Glance HA</h2>
<p>Create glance database</p>
<pre><code>glance-deploy --user ubuntu --hosts CONTROLLER1 create-glance-db --root-db-pass changeme --glance-db-pass changeme
</code></pre>
<p>Create service credentials</p>
<pre><code>glance-deploy --user ubuntu --hosts CONTROLLER1 create-service-credentials --os-password changeme --os-auth-url http://CONTROLLER_VIP:35357/v3 --glance-pass changeme --public-endpoint http://CONTROLLER_VIP:9292 --internal-endpoint http://CONTROLLER_VIP:9292 --admin-endpoint http://CONTROLLER_VIP:9292
</code></pre>
<p>Install glance on CONTROLLER1 and CONTROLLER2</p>
<pre><code>glance-deploy --user ubuntu --hosts CONTROLLER1 install --connection mysql+pymysql://glance:GLANCE_PASS@CONTROLLER_VIP/glance --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --glance-pass changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --populate
glance-deploy --user ubuntu --hosts CONTROLLER2 install --connection mysql+pymysql://glance:GLANCE_PASS@CONTROLLER_VIP/glance --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --glance-pass changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
</code></pre>
<h2><a id="Nova_HA_154"></a>Nova HA</h2>
<p>Create nova database</p>
<pre><code>nova-deploy --user ubuntu --hosts CONTROLLER1 create-nova-db --root-db-pass changeme --nova-db-pass changeme
</code></pre>
<p>Create service credentials</p>
<pre><code>nova-deploy --user ubuntu --hosts CONTROLLER1 create-service-credentials --os-password changeme --os-auth-url http://CONTROLLER_VIP:35357/v3 --nova-pass changeme --public-endpoint 'http://CONTROLLER_VIP:8774/v2.1/%\(tenant_id\)s' --internal-endpoint 'http://CONTROLLER_VIP:8774/v2.1/%\(tenant_id\)s' --admin-endpoint 'http://CONTROLLER_VIP:8774/v2.1/%\(tenant_id\)s'
</code></pre>
<p>Install nova on CONTROLLER1</p>
<pre><code>nova-deploy --user ubuntu --hosts CONTROLLER1 install --connection mysql+pymysql://nova:NOVA_PASS@CONTROLLER_VIP/nova --api-connection mysql+pymysql://nova:NOVA_PASS@CONTROLLER_VIP/nova_api --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --nova-pass changeme --my-ip MANAGEMENT_IP --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --glance-api-servers http://CONTROLLER_VIP:9292 --neutron-endpoint http://CONTROLLER_VIP:9696 --neutron-pass changeme --metadata-proxy-shared-secret changeme --populate
</code></pre>
<p>Install nova on CONTROLLER2</p>
<pre><code>nova-deploy --user ubuntu --hosts CONTROLLER2 install --connection mysql+pymysql://nova:NOVA_PASS@CONTROLLER_VIP/nova --api-connection mysql+pymysql://nova:NOVA_PASS@CONTROLLER_VIP/nova_api --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --nova-pass changeme --my-ip MANAGEMENT_IP --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --glance-api-servers http://CONTROLLER_VIP:9292 --neutron-endpoint http://CONTROLLER_VIP:9696 --neutron-pass changeme --metadata-proxy-shared-secret changeme
</code></pre>
<h2><a id="Nova_Compute_172"></a>Nova Compute</h2>
<p>Add nova computes(use <code>uuidgen</code> to generate the ceph uuid)</p>
<pre><code>nova-compute-deploy --user ubuntu --hosts COMPUTE1 install --my-ip MANAGEMENT_IP --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --nova-pass changeme --novncproxy-base-url http://CONTROLLER_VIP:6080/vnc_auto.html --glance-api-servers http://CONTROLLER_VIP:9292 --neutron-endpoint http://CONTROLLER_VIP:9696 --neutron-pass changeme --rbd-secret-uuid changeme-changeme-changeme-changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
nova-compute-deploy --user ubuntu --hosts COMPUTE2 install --my-ip MANAGEMENT_IP --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --nova-pass changeme --novncproxy-base-url http://CONTROLLER_VIP:6080/vnc_auto.html --glance-api-servers http://CONTROLLER_VIP:9292 --neutron-endpoint http://CONTROLLER_VIP:9696 --neutron-pass changeme --rbd-secret-uuid changeme-changeme-changeme-changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
</code></pre>
<p>The libvirt defaults to using ceph as shared storage, the ceph pool for running instance is vms. if you do not using ceph as itâ€™s bachend, you must remove the following param:</p>
<pre><code>images_type = rbd
images_rbd_pool = vms
images_rbd_ceph_conf = /etc/ceph/ceph.conf
rbd_user = cinder
rbd_secret_uuid = changeme-changeme-changeme-changeme
disk_cachemodes=&quot;network=writeback&quot;
live_migration_flag=&quot;VIR_MIGRATE_UNDEFINE_SOURCE,VIR_MIGRATE_PEER2PEER,VIR_MIGRATE_LIVE,VIR_MIGRATE_PERSIST_DEST,VIR_MIGRATE_TUNNELLED&quot;
</code></pre>
<h2><a id="Neutron_HA_190"></a>Neutron HA</h2>
<p>Create nova database</p>
<pre><code>neutron-deploy --user ubuntu --hosts CONTROLLER1 create-neutron-db --root-db-pass changeme --neutron-db-pass changeme
</code></pre>
<p>Create service credentials</p>
<pre><code>neutron-deploy --user ubuntu --hosts CONTROLLER1 create-service-credentials --os-password changeme --os-auth-url http://CONTROLLER_VIP:35357/v3 --neutron-pass changeme --public-endpoint http://CONTROLLER_VIP:9696 --internal-endpoint http://CONTROLLER_VIP:9696 --admin-endpoint http://CONTROLLER_VIP:9696
</code></pre>
<p>Install Neutron for self-service</p>
<pre><code>neutron-deploy --user ubuntu --hosts CONTROLLER1 install --connection mysql+pymysql://neutron:NEUTRON_PASS@CONTROLLER_VIP/neutron --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --neutron-pass changeme --nova-url http://CONTROLLER_VIP:8774/v2.1 --nova-pass changeme --public-interface eth1 --local-ip MANAGEMENT_INTERFACE_IP --nova-metadata-ip CONTROLLER_VIP --metadata-proxy-shared-secret changeme-changeme-changeme-changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --populate
neutron-deploy --user ubuntu --hosts CONTROLLER2 install --connection mysql+pymysql://neutron:NEUTRON_PASS@CONTROLLER_VIP/neutron --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --neutron-pass changeme --nova-url http://CONTROLLER_VIP:8774/v2.1 --nova-pass changeme --public-interface eth1 --local-ip MANAGEMENT_INTERFACE_IP --nova-metadata-ip CONTROLLER_VIP --metadata-proxy-shared-secret changeme-changeme-changeme-changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
</code></pre>
<h2><a id="Neutron_Agent_206"></a>Neutron Agent</h2>
<p>Install neutron agent on compute nodes</p>
<pre><code>neutron-agent-deploy --user ubuntu --hosts COMPUTE1 install --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --neutron-pass changeme --public-interface eth1 --local-ip MANAGEMENT_INTERFACE_IP --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
neutron-agent-deploy --user ubuntu --hosts COMPUTE2 install --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass changeme --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --neutron-pass changeme --public-interface eth1 --local-ip MANAGEMENT_INTERFACE_IP --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
</code></pre>
<h2><a id="Horizon_HA_214"></a>Horizon HA</h2>
<p>Install horizon on controller nodes</p>
<pre><code>horizon-deploy --user ubuntu --hosts CONTROLLER1,CONTROLLER2 install --openstack-host CONTROLLER_VIP  --memcached-servers CONTROLLER1:11211 --time-zone Asia/Shanghai
</code></pre>
<h2><a id="Cinder_HA_221"></a>Cinder HA</h2>
<p>Create cinder database</p>
<pre><code>cinder-deploy --user ubuntu --hosts CONTROLLER1 create-cinder-db --root-db-pass changeme --cinder-db-pass changeme
</code></pre>
<p>Create cinder service creadentials</p>
<pre><code>cinder-deploy --user ubuntu --hosts CONTROLLER1 create-service-credentials --os-password changeme --os-auth-url http://CONTROLLER_VIP:35357/v3 --cinder-pass changeme --public-endpoint-v1 'http://CONTROLLER_VIP:8776/v1/%\(tenant_id\)s' --internal-endpoint-v1 'http://CONTROLLER_VIP:8776/v1/%\(tenant_id\)s' --admin-endpoint-v1 'http://CONTROLLER_VIP:8776/v1/%\(tenant_id\)s' --public-endpoint-v2 'http://CONTROLLER_VIP:8776/v2/%\(tenant_id\)s' --internal-endpoint-v2 'http://CONTROLLER_VIP:8776/v2/%\(tenant_id\)s' --admin-endpoint-v2 'http://CONTROLLER_VIP:8776/v2/%\(tenant_id\)s'
</code></pre>
<p>Install cinder-api and cinder-volume on controller nodes, the volume backend defaults to ceph (you must have ceph installed)</p>
<pre><code>cinder-deploy --user ubuntu --hosts CONTROLLER1 install --connection mysql+pymysql://cinder:CINDER_PASS@CONTROLLER_VIP/cinder --rabbit-user openstack --rabbit-pass changeme --rabbit-hosts CONTROLLER1,CONTROLLER2 --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --cinder-pass changeme --my-ip MANAGEMENT_INTERFACE_IP --glance-api-servers http://CONTROLLER_VIP:9292 --rbd-secret-uuid changeme-changeme-changeme-changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --populate
cinder-deploy --user ubuntu --hosts CONTROLLER2 install --connection mysql+pymysql://cinder:CINDER_PASS@CONTROLLER_VIP/cinder --rabbit-user openstack --rabbit-pass changeme --rabbit-hosts CONTROLLER1,CONTROLLER2 --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --cinder-pass changeme --my-ip MANAGEMENT_INTERFACE_IP --glance-api-servers http://CONTROLLER_VIP:9292 --rbd-secret-uuid changeme-changeme-changeme-changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
</code></pre>
<h2><a id="Swift_proxy_HA_236"></a>Swift proxy HA</h2>
<p>Create the Identity service credentials</p>
<pre><code>swift-deploy --user ubuntu --hosts CONTROLLER1 create-service-credentials --os-password changeme --os-auth-url http://CONTROLLER_VIP:35357/v3 --swift-pass changeme --public-endpoint 'http://CONTROLLER_VIP:8080/v1/AUTH_%\(tenant_id\)s' --internal-endpoint 'http://CONTROLLER_VIP:8080/v1/AUTH_%\(tenant_id\)s' --admin-endpoint http://CONTROLLER_VIP:8080/v1
</code></pre>
<p>Install swift proxy</p>
<pre><code>swift-deploy --user ubuntu --hosts CONTROLLER1,CONTROLLER2 install --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --swift-pass changeme --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211
</code></pre>
<h2><a id="Swift_storage_247"></a>Swift storage</h2>
<p>Prepare disks on storage node</p>
<pre><code>swift-storage-deploy --user ubuntu --hosts OBJECT1,OBJECT2 prepare-disks --name sdb,sdc,sdd,sde
</code></pre>
<p>Install swift storage on storage node</p>
<pre><code>swift-storage-deploy --user ubuntu --hosts OBJECT1 install --address MANAGEMENT_INTERFACE_IP --bind-ip MANAGEMENT_INTERFACE_IP
swift-storage-deploy --user ubuntu --hosts OBJECT2 install --address MANAGEMENT_INTERFACE_IP --bind-ip MANAGEMENT_INTERFACE_IP
</code></pre>
<p>Create account ring on controller node</p>
<pre><code>swift-storage-deploy --user ubuntu --hosts CONTROLLER1 create-account-builder-file --partitions 10 --replicas 3 --moving 1
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdb --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdc --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdd --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sde --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdb --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdc --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdd --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sde --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 account-builder-rebalance
</code></pre>
<p>Create container ring on controller node</p>
<pre><code>swift-storage-deploy --user ubuntu --hosts CONTROLLER1 create-container-builder-file --partitions 10 --replicas 3 --moving 1
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdb --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdc --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdd --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sde --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdb --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdc --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdd --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sde --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 container-builder-rebalance
</code></pre>
<p>Create object ring on controller node</p>
<pre><code>swift-storage-deploy --user ubuntu --hosts CONTROLLER1 create-object-builder-file --partitions 10 --replicas 3 --moving 1
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdb --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdc --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sdd --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT1_MANAGEMENT_IP --device sde --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdb --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdc --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sdd --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-add --region 1 --zone 1 --ip OBJECT2_MANAGEMENT_IP --device sde --weight 100
swift-storage-deploy --user ubuntu --hosts CONTROLLER1 object-builder-rebalance
</code></pre>
<p>Sync the builder file from controller node to each storage node and other any proxy node</p>
<pre><code>swift-storage-deploy --user ubuntu --host CONTROLLER1 sync-builder-file --to CONTROLLER2,OBJECT1,OBJECT2
</code></pre>
<p>Finalize installation on all nodes</p>
<pre><code>swift-deploy --user ubuntu --hosts CONTROLLER1,CONTROLLER2,OBJECT1,OBJECT2 finalize-install --swift-hash-path-suffix changeme --swift-hash-path-prefix changeme
</code></pre>
<h2><a id="Option_Ceph_Guide_305"></a>(Option) Ceph Guide</h2>
<p>For more information about ceph backend visit:</p>
<p><a href="http://docs.ceph.com/docs/jewel/start/quick-start-preflight/">preflight</a></p>
<p><a href="http://docs.ceph.com/docs/jewel/rbd/rbd-openstack/">Cinder and Glance driver</a></p>
<p>On Xenial please using ceph-deploy version 1.5.34</p>
<p>Install ceph-deploy(1.5.34)</p>
<pre><code>wget -q -O- 'https://download.ceph.com/keys/release.asc' | sudo apt-key add -
echo deb http://download.ceph.com/debian-jewel/ $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/ceph.list
sudo apt-get update &amp;&amp; sudo apt-get install ceph-deploy
</code></pre>
<p>Create ceph cluster directory</p>
<pre><code>mkdir ceph-cluster
cd ceph-cluster
</code></pre>
<p>Create cluster and add initial monitor(s) to the ceph.conf</p>
<pre><code>ceph-deploy new  CONTROLLER1 CONTROLLER2 COMPUTE1 COMPUTE2 BLOCK1 BLOCK2
echo &quot;osd pool default size = 2&quot; | tee -a ceph.conf
</code></pre>
<p>Install ceph client(Optionaly you can use <code>--release jewel</code> to install jewel version, the ceph-deploy 1.5.34 default release is jewel) and you can use <code>--repo-url http://your-local-repo.example.org/mirror/download.ceph.com/debian-jewel</code> to specify the local repository.</p>
<pre><code>ceph-deploy install PLAYBACK-NODE CONTROLLER1 CONTROLLER2 COMPUTE1 COMPUTE2 BLOCK1 BLOCK2
</code></pre>
<p>Add the initial monitor(s) and gather the keys</p>
<pre><code>ceph-deploy mon create-initial
</code></pre>
<p>If you want to add additional monitors, do that</p>
<pre><code>ceph-deploy mon add {additional-monitor}
</code></pre>
<p>Add ceph osd(s)</p>
<pre><code>ceph-deploy osd create --zap-disk BLOCK1:/dev/sdb
ceph-deploy osd create --zap-disk BLOCK1:/dev/sdc
ceph-deploy osd create --zap-disk BLOCK2:/dev/sdb
ceph-deploy osd create --zap-disk BLOCK2:/dev/sdc
</code></pre>
<p>Sync admin key</p>
<pre><code>ceph-deploy admin PLAYBACK-NODE CONTROLLER1 CONTROLLER2 COMPUTE1 COMPUTE2 BLOCK1 BLOCK2
sudo chmod +r /etc/ceph/ceph.client.admin.keyring # On all ceph clients node
</code></pre>
<p>Create osd pool for cinder and running instance</p>
<pre><code>ceph osd pool create volumes 512
ceph osd pool create vms 512
ceph osd pool create images 512
</code></pre>
<p>Setup ceph client authentication</p>
<pre><code>ceph auth get-or-create client.cinder mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=volumes, allow rwx pool=vms, allow rx pool=images'
ceph auth get-or-create client.glance mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=images'
</code></pre>
<p>Add the keyrings for <code>client.cinder</code> and <code>client.glance</code> to appropriate nodes and change their ownership</p>
<pre><code>ceph auth get-or-create client.cinder | sudo tee /etc/ceph/ceph.client.cinder.keyring # On all cinder-volume nodes
sudo chown cinder:cinder /etc/ceph/ceph.client.cinder.keyring&quot; # On all cinder-volume nodes

ceph auth get-or-create client.glance | sudo tee /etc/ceph/ceph.client.glance.keyring # On all glance-api nodes
sudo chown glance:glance /etc/ceph/ceph.client.glance.keyring&quot; # On all glance-api nodes
</code></pre>
<p>Nodes running <code>nova-compute</code> need the keyring file for the <code>nova-compute</code> process</p>
<pre><code>ceph auth get-or-create client.cinder | sudo tee /etc/ceph/ceph.client.cinder.keyring # On all nova-compute nodes
</code></pre>
<p>They also need to store the secret key of the <code>client.cinder user</code> in <code>libvirt</code>. The libvirt process needs it to access the cluster while attaching a block device from Cinder.
Create a temporary copy of the secret key on the nodes running <code>nova-compute</code></p>
<pre><code>ceph auth get-key client.cinder | tee client.cinder.key # On all nova-compute nodes
</code></pre>
<p>Then, on the <code>compute nodes</code>, add the secret key to <code>libvirt</code> and remove the temporary copy of the key(the uuid is the same as your --rbd-secret-uuid option, you have to save the uuid for later)</p>
<pre><code>uuidgen
457eb676-33da-42ec-9a8c-9293d545c337

# The following steps on all nova-compute nodes
cat &gt; secret.xml &lt;&lt;EOF
&lt;secret ephemeral='no' private='no'&gt;
  &lt;uuid&gt;457eb676-33da-42ec-9a8c-9293d545c337&lt;/uuid&gt;
  &lt;usage type='ceph'&gt;
    &lt;name&gt;client.cinder secret&lt;/name&gt;
  &lt;/usage&gt;
&lt;/secret&gt;
EOF
sudo virsh secret-define --file secret.xml
Secret 457eb676-33da-42ec-9a8c-9293d545c337 created
sudo virsh secret-set-value --secret 457eb676-33da-42ec-9a8c-9293d545c337 --base64 $(cat client.cinder.key) &amp;&amp; rm client.cinder.key secret.xml
</code></pre>
<p>(optional)Now on every compute nodes edit your Ceph configuration file, add the client section</p>
<pre><code>[client]
rbd cache = true
rbd cache writethrough until flush = true
rbd concurrent management ops = 20

[client.cinder]
keyring = /etc/ceph/ceph.client.cinder.keyring
</code></pre>
<p>(optional)On every glance-api nodes edit your Ceph configuration file, add the client section</p>
<pre><code>[client.glance]
keyring= /etc/ceph/ceph.client.glance.keyring
</code></pre>
<p>(optional)If you want to remove osd</p>
<pre><code>sudo stop ceph-mon-all &amp;&amp; sudo stop ceph-osd-all # On osd node
ceph osd out {OSD-NUM}
ceph osd crush remove osd.{OSD-NUM}
ceph auth del osd.{OSD-NUM}
ceph osd rm {OSD-NUM}
ceph osd crush remove {HOST}
</code></pre>
<p>(optional)If you want to remove monitor</p>
<pre><code>ceph mon remove {MON-ID}
</code></pre>
<p>Notes: you need to restart the <code>nova-compute</code>, <code>cinder-volume</code> and <code>glance-api</code> services to finalize the installation.</p>
<h2><a id="Shared_File_Systems_service_431"></a>Shared File Systems service</h2>
<p>Create manila database and service credentials</p>
<pre><code>manila-deploy --user ubuntu --hosts CONTROLLER1 create-manila-db --root-db-pass CHANGEME --manila-db-pass CHANGEME
manila-deploy --user ubuntu --hosts CONTROLLER1 create-service-credentials --os-password CHANGEME --os-auth-url http://CONTROLLER_VIP:35357/v3 --manila-pass CHANGEME --public-endpoint-v1 &quot;http://CONTROLLER_VIP:8786/v1/%\(tenant_id\)s&quot; --internal-endpoint-v1 &quot;http://CONTROLLER_VIP:8786/v1/%\(tenant_id\)s&quot; --admin-endpoint-v1 &quot;http://CONTROLLER_VIP:8786/v1/%\(tenant_id\)s&quot; --public-endpoint-v2 &quot;http://CONTROLLER_VIP:8786/v2/%\(tenant_id\)s&quot; --internal-endpoint-v2 &quot;http://CONTROLLER_VIP:8786/v2/%\(tenant_id\)s&quot; --admin-endpoint-v2 &quot;http://CONTROLLER_VIP:8786/v2/%\(tenant_id\)s&quot;
</code></pre>
<p>Install manila on CONTROLLER1 and CONTROLLER2</p>
<pre><code>manila-deploy --user ubuntu --hosts CONTROLLER1 install --connection mysql+pymysql://manila:CHANGEME@CONTROLLER_VIP/manila --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --manila-pass CHANGEME --my-ip CONTROLLER1 --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass CHANGEME --populate
manila-deploy --user ubuntu --hosts CONTROLLER2 install --connection mysql+pymysql://manila:CHANGEME@CONTROLLER_VIP/manila --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --manila-pass CHANGEME --my-ip CONTROLLER2 --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass CHANGEME
</code></pre>
<p>Install manila share on CONTROLLER1 and CONTROLLER2</p>
<pre><code>manila-share-deploy --user ubuntu --hosts CONTROLLER1 install --connection mysql+pymysql://manila:CHANGEME@CONTROLLER_VIP/manila --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --manila-pass CHANGEME --my-ip CONTROLLER1 --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass CHANGEME --neutron-endpoint http://CONTROLLER_VIP:9696 --neutron-pass CHANGEME --nova-pass CHANGEME --cinder-pass CHANGEME
manila-share-deploy --user ubuntu --hosts CONTROLLER2 install --connection mysql+pymysql://manila:CHANGEME@CONTROLLER_VIP/manila --auth-uri http://CONTROLLER_VIP:5000 --auth-url http://CONTROLLER_VIP:35357 --manila-pass CHANGEME --my-ip CONTROLLER2 --memcached-servers CONTROLLER1:11211,CONTROLLER2:11211 --rabbit-hosts CONTROLLER1,CONTROLLER2 --rabbit-user openstack --rabbit-pass CHANGEME --neutron-endpoint http://CONTROLLER_VIP:9696 --neutron-pass CHANGEME --nova-pass CHANGEME --cinder-pass CHANGEME
</code></pre>
<p>Create the service image for manila</p>
<p><a href="http://docs.openstack.org/mitaka/install-guide-ubuntu/launch-instance-manila.html">http://docs.openstack.org/mitaka/install-guide-ubuntu/launch-instance-manila.html</a></p>
<p>Create shares with share servers management support</p>
<p><a href="http://docs.openstack.org/mitaka/install-guide-ubuntu/launch-instance-manila-dhss-true-option2.html">http://docs.openstack.org/mitaka/install-guide-ubuntu/launch-instance-manila-dhss-true-option2.html</a></p>
<h2><a id="Library_Use_456"></a>Library Use</h2>
<pre><code class="language-Python"><span class="hljs-keyword">from</span> playback.api <span class="hljs-keyword">import</span> *
admin_token = <span class="hljs-string">'changeme'</span>
connection = <span class="hljs-string">'mysql+pymysql://keystone:changeme@CONTROLLER_VIP/keystone'</span>
memcache_servers = <span class="hljs-string">'CONTROLLER1:11211,CONTROLLER2:11211'</span>

keystone = Keystone(user=<span class="hljs-string">'ubuntu'</span>, hosts=<span class="hljs-string">'controller1,controller2'</span>)
ececute(keystone._install_keystone, admin_token, connection, memcache_servers)
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jiasir/playback">Playback</a> is maintained by <a href="https://github.com/jiasir">jiasir</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
